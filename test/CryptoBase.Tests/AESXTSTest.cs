using CryptoBase.Abstractions.SymmetricCryptos;
using CryptoBase.DataFormatExtensions;
using CryptoBase.SymmetricCryptos.BlockCryptoModes;
using CryptoBase.SymmetricCryptos.BlockCryptos.AES;
using System.Security.Cryptography;

namespace CryptoBase.Tests;

public class AESXTSTest
{
	public static readonly TheoryData<string, UInt128, string, string> Data = new()
	{
		{ "a3e40d5bd4b6bbedb2d18c700ad2db2210c81190646d673cbca53f133eab373c", 141, "20e0719405993f09a66ae5bb500e562c", "74623551210216ac926b9650b6d3fa52" },
		{ "a2ed35e8d082f5e13e78c1d42acf33cf70e82821a666b2a7606542e43a631226", 75, "2d81dcdec507845dcac4af1594aac844", "050dc32995cf6cd87224dfa2572709f4" },
		{ "69438582e0a61b5e7a023adf2f419630ed537ccf9a4b2e09010eaf7b66bcf818", 232, "05c2c05e812bc4295f3ef64c8bc468ee946176449edc481785e6c6d9fbdd6b8f", "27259ec330a66591e265525cd1eb5017ba195a390e4f66ddfb7c1a4b0fb5e49d" },
		{ "f5409a68908c710aacc31a223ef7911db3202772edd955663a75292d9384ca2c", 100, "ce1a975b08eec5a005708cd4113a701fb0377b14b59e70dc06fe6941121f16a2", "39d7b54434622b53a78529043bffa0f637e46a79c880cae70c67b1f2077e1932" },
		{ "fb46fb3cab7f67ad5207bc232c50dcbb24dbd1564590855d4cb777b3ba6431c3", 117, "46409f7426eb4e3d33480534b80fe6e09fed6583907eb83c84", "a19d9b3209d388740a581975091fe26deecbb0f117c22b0ae4" },
		{ "583d530d49942feafac523b980b816005759db2856ba62299783fc0f24da6066", 104, "a8378b828f615d5f8c5e394aaa9a3de3f49cee701d661f23b5", "d4ee9facfea79ae857fd43e25da5d950b1a1e6277e9fa50a3d" },
		{ "ef010ca1a3663e32534349bc0bae62232a1573348568fb9ef41768a7674f507a727f98755397d0e0aa32f830338cc7a926c773f09e57b357cd156afbca46e1a0", 187, "ed98e01770a853b49db9e6aaf88f0a41b9b56e91a5a2b11d40529254f5523e75", "ca20c55e8dc149687d2541de39c3df6300bb5a163c10ced3666b1357db8bd39d" },
		{ "c4e6b37e1075969d41a7601aa105dd41b18200a028da1f79f55c4d2db478c4e98d9ed491cfe52f31ecb7cbb4891eb779e057392b3b27c19cbe9b4875c8c31c22", 223, "87ede402d0561359799a41be042ced9a8e15639165ef1a4d2f6785c394d61e5f", "a51037198f3f9fe5d05bef52363acec40e86e3abb834180348d2e08627733e65" },
		{ "f6db5326ea996b16ca0d439b5a0106e3a34ed343db489faad06979009399b03b3cd9ef23332d46414216531d9885a5a30b1964523992f42748202b80a4190d45", 245, "bf6a09f93f94d6bdc8c5f5e158916c3371a540e46644f79414d84dda1339397ce90ebb768deeb88ecd2be175a396bb85", "b11a252c5776c439ea7baeaae7830418e574b2248cc8b524b7fd0cc8e1ecffa9812f45ae313e3e1f44127b27fb08a613" },
		{ "182614c12c49df2a50b8f9e985e9674253f141c17b6d440fcbbe4319d7034a87fe4db5c45e54086f62fde76999099fa71a3aae56c6a3220e226ccc2147f83a4f", 185, "e6f5621b062241c835e6fed103c089c782ceeab7035f4c6bb47bc35416599174b53608918c3ee5da1ab9736d8c8decc3", "9b2e2eef1b8c24a78f8ed47a0d30d8c8badbf70cf138292dfc2d3dc211aabc2e4ec0ef36c94e0505255e3acc5e13943a" }
	};

	public static readonly TheoryData<string, string, string, string> Data2 = new()
	{
		{ "a1b90cba3f06ac353b2c343876081762090923026e91771815f29dab01932f2f", "4faef7117cda59c66e4b92013e768ad5", "ebabce95b14d3c8d6fb350390790311c", "778ae8b43cb98d5a825081d5be471c63" },
		{ "8f59462c1327fd6411cb6b02c04bf0a129f145c276a38693c745de3118c90a2f", "f2b86793b29e730e4a627b6ee161706c", "f7049f8aa312aeb1ab99ad11a1d7a720", "e59fca86c3c906f3df67418636a28767" },
		{ "b7b93f516aef295eff3a29d837cf1f135347e8a21dae616ff5062b2e8d78ce5e", "873edea653b643bd8bcf51403197ed14", "236f8a5b58dd55f6194ed70c4ac1a17f1fe60ec9a6c454d087ccb77d6b638c47", "22e6a3c6379dcf7599b052b5a749c7f78ad8a11b9f1aa9430cf3aef445682e19" },
		{ "750372c3d82f63382867be6662acfa4a259be3fa9bc662a1154ffaaed8b448a5", "93a29254c47e4260669621307d4f5cd3", "d8e3a56559a436ce0d8b212c80a88b23af62b0e598f208e03c1f2e9fa563a54b", "495f7855535efd133464dc9a9abf8a0f28facbce21bd3c22178ec489b799e491" },
		{ "394c97881abd989d29c703e48a72b397a7acf51b59649eeea9b33274d8541df4", "4b15c684a152d485fe9937d39b168c29", "2f3b9dcfbae729583b1d1ffdd16bb6fe2757329435662a78f0", "f3473802e38a3ffef4d4fb8e6aa266ebde553a64528a06463e" },
		{ "8afb90c2ec924c4b0b0bd840fb1efc842c9385a14d1ca95bd4d12cbf9ab588ed", "b2f8c6374eb275c1744e85aa21f8ea6b", "d9d8f00683bcd489154882290f24624726e093390783d4959a", "f4bbaa8ebd480d2a2a371beab3d8b387c02282678c6000227b" },
		{ "1ea661c58d943a0e4801e42f4b0947149e7f9f8e3e68d0c7505210bd311a0e7cd6e13ffdf2418d8d1911c004cda58da3d619b7e2b9141e58318eea392cf41b08", "adf8d92627464ad2f0428e84a9f87564", "2eedea52cd8215e1acc647e810bbc3642e87287f8d2e57e36c0a24fbc12a202e", "cbaad0e2f6cea3f50b37f934d46a9b130b9d54f07e34f36af793e86f73c6d7db" },
		{ "e149be00177d76b7c1d85bcbb6b5054ee10b9f51cd73f59e0840628b9e7d854e2e1c0ab0537186a2a7c314bbc5eb23b6876a26bcdbf9e6b758d1cae053c2f278", "0ea18818fab95289b1caab4e61349501", "f5f101d8e3a7681b1ddb21bd2826b24e32990bca49b39291b5369a9bca277d75", "5bf2479393cc673306fbb15e72600598e33d4d8a470727ce098730fd80afa959" },
		{ "266c336b3b01489f3267f52835fd92f674374b88b4e1ebd2d36a5f457581d9d042c3eef7b0b7e5137b086496b4d9e6ac658d7196a23f23f036172fdb8faee527", "06b209a7a22f486ecbfadb0f3137ba42", "ca7d65ef8d3dfad345b61ccddca1ad81de830b9e86c7b426d76cb7db766852d981c6b21409399d78f42cc0b33a7bbb06", "c73256870cc2f4dd57acc74b5456dbd776912a128bc1f77d72cdebbf270044b7a43ceed29025e1e8be211fa3c3ed002d" },
		{ "7d12d5eaf687a3edf4ef0a284a6c7e9cfa075185e2608c2003b5f2719f81dec92d107279d6f1985b4b950e168b8af70b6e6e0b4419ddb50f425d673fa3714a38", "d63bba65b05d175a90de1003624e1d9f", "752e9b0b241e91fad431e0b900b5b697f875c0898d3d58b93b74723c032fd103bcc555a7b8be44a9d1e7726e7f31d2c7", "ad6f2c59c6130f0814bfebcb3f5e7833d6dbccb24c3311642806f965ff4435602d9d3e39851a495cfada67f8b3017ae7" }
	};

	public static readonly TheoryData<string, string, string, string> Data3 = new()
	{
		{ "af161950be7fa980243bf657c865a5fd2585e5f67cd04ef32563127bade41719", "a8e7ea0ac39591fbc7cb840164f0fb4a", "997d7614e4de0df1e6e7284d4d3485e44f4067813fa9fe4f9046679e655fc21538e08b3521efa2ae54711ca174f93caead45b36c90f0332e94470a1ba7c93c212d15c6933c4151c8d464d72d1197f6b1dbfe9a121c3546134c71b6a6eed0f27ef6f5334776ea11d44efb115851aa5537b0eab3261a94edf35136782e9ac970e9b22e902b93a35553124d8436466c98ef1c805bae8202185b708914cba282d147b7cff844e51a443644e8911565125dd73d30c33532c2c17feef5439614f1fb2e02fc79c42b6949fb29aa66a9d6ce786a6592e3ed8fe659cb5e8dee86608c431a44332f6ae6d8bf4f3cd7c943905c71516eacbcc1a8a8972d56bafe84d8d4e9bc4d4dfc62245a082fe737f5c75aa2992d2256de6eb8da31ae99a63361b6803650f5a00d077ef8c75b2170758220b589080a70dccffb9e1668f8706713539286157920e1f08c7c1ad64dd6a7733d34af95a9e03ba5c3564026c32e7e43ea0e05a0dbd16102cacf2f630948390c749c233ce33d751d65ac8e3bd0293d80255c13b99f5a42b437c66967dde9d9079e2ccf775901aad4b6a14e7f65c12b11f9317a262911e14094ee12ddc2b1db97fe446a5a8fc87d926f243174268689385dc4611659093cb97c9cf98176d556472aeb22511f9a821d076867d8f826ec49a216238b07e230be3a4bb310cf33e5f83003ed7b43948cfc882310317fe0f68e7e560e36b10159024ebdd4a8fe522fa98a8ea20aa9f570b80b6765cc985ce3428b7ebf9e4c524e187ce772c4929564aa80f600cdf8dfffc3b971d6c176b2915fa5a92afeef0ffa13bdb033ea28eac722c2825ca41a13c4b920f5a88bb5aa46a5aac4add6ccf61da2b2ee9e7594ad8935701d979d049692f82521367bd0357485e97d3d72fb33b1503033b5b84cea27b9a3eecfa68cfef1785d1c522a7922d0e53242b0336110598ac06002984d51630278383f7fa68f4645f7d651a6bba87878c6ecc531949263649e43a5ee8e43aba83c4da04e1de5d92a8a21cb221df53799c925e8a0917320e8076ee61242581fb037b7d883307195e223dc660747e225da6e3c941bc9f826f766e11dce60a4f2e2bdf58c413d56395d4218a7bfefb15abd4498e974264377c0e242d824ba5d0f8c972a9cda221a78d7a794e9265b99393f83f82c64a0d5869c3a7a9a7e176ac7068667229e02cf79f2b24339c80ba88ece9e3de8df4e632b5b6b331abb5b47330e0805da8697b867c68494d69640c440809e63f05fc1c6d9c63d774e9bf76f9afab2f2af74fe162f112beead95d21d997c4b554136a94695e6d6ea1bc5a13c4ea0138cdfbb2494628c4d500c0311c3241bd5d7e87c79e5335f3efe574e299118b5a0d96466032438683957e41bb2e95da2c461e91fd4fffd1b8fbb443c4230161ed57b55d0d595feb3a75fdb04b5a9fdb49012e7", "e0d5f2b8c0269ba4ae2db31521b11f474cfd655d837a0a883b6222e89eb2fbe651a42a983cbd2713b7118444cc571324000793a700b9c8cd5aff65b0016568c7662d7604bd2fdd75ebc35ca80cb566b42a5a2e252044782a0aaf23b1bb7ccc2e63a51f472fcf6242117daf23172d3651ea2d1b36c3c815a1157779c674d3d74009d4b6fb38acc531ab7b5ff6d78e09237257469ba345c76e8aa22b378046c864354212fa49e0781bd0472588488a695f328f74a9fea47aa1ca03b82abadc3e1282993c231d6b8734a00b9cc346f52cba166f20e5ec36424f35b3c73280bbaed99ba02dad88ab093519d3d9749d2db709bbca5be3fae2c04a085c9cc55224b9700758cfc15c89bf7291f2527d3c6b52003ae6d6261f06f26f3e034ff3429d7130b0ead4ae3e1cadb3492bf50dc11476575396a55b53d3feaa3344077f13e1315246322f1eada805de971a62753b8d932255250c761f8d0e27e2607a6e9e09e6d108ed5204716de2272e7209e002e1e12734447bac9d4a0b3cf3900dc207652ff134ac009e2d0cf76f0cae780a403ebfbf04d53cb05b3d9f0a51f3b5d186d52ae6d1bfa37b06e380acb5ad8e8cd8c05815fa09d67d1ac04e8794a2725dcfd0c2815e7a11c968440ba72d58cddeaa4aa0e7acdb1610ebc1ecdf289ad7599f53e4c1881be1ed6bd3abbc344f6b7a9bb7d7039ddd5cde6eb128468b3afbcfc35d6b711e9125438d3d77b9b7d5a72ce3e7b846cddf4cb9c54a224d8c7c9d262e7187754a207139ad403b67b4a73e5d83d594ffd39c03cb732ed3f59d05be356de373e58e617e060b843406735502aef4143c8c5e74d54bda3ceadf733db6b1ee25c626e249d57ce2520773bb32bb0752ee83ac0af04481383cbf040d91924792efc8d021d9d711b82f35230a9e9cc2ebc0d543b8143775a8c368a77d728c5363264d9bd2e6204dc5f9af4a78623687203bf93672ec88a83811f853cf2f6d30399029c9ce7f5120d8d3ac36a1afe9e509a9b458c542c34ca768f2e59d922efcbf16af661ad991c61a7910e846484d2f6f7772b3049c36473c6ac6ce4f237abf175cb9e22c7d735d617c9745d59f1391e8fc70a37858c9bcb8fa95a5a968c8cb993a3893bff8c4f15df7feeb303a2f50fe56f3c5608b6fa2dddea87c09b0cd3029eee6450e1d272ae4617d57dc3d7f0373d97b8612aaa47352dbe3d9213f9ea29475312062f5069868a5e6fb0032c268f74db190c889a9181c20f7d358a90a03ff0a7ea26c6df7dda9cfbf82a9210350ef3d997101001ee1a7273ee100952ad5c4e802fc379c4c8bad12c6185fd39d2a0f8f8150acebfe02156f9fb2f7416be1c2c852ad0d26b0acfec9fe4148f076eca59b718f161dbabdc2dfa1eaa35866389f4814f0378f10e3370c45de9a653e17dabd48da7a638545dc8b0735bdc0ffe6841fd4" },
		{ "74f2e46cdb9d384d6401e154f7d722e082e6127a0c1782e3e5a34167c66a09f8890453969d751a2bd96a1578c42454c5aab4f7855e76dffe5bcf362bcd3b2d4d", "c2611fedb09db80cf59dafb12063d542", "7b796061426dd1aa2682f904e2ebbc1d6087cff35bd63beff67dcdba53f1e92845649e63df8e1473178385b32d6526848785985656883f6e39e8f1a262d62b19dddb52b50a30c27fdf92d54c5843d4d35b7372a26cfbe971bc0b1a318abc10b54dd6c082c450f3a76828b61bf79f4ab6e430c04682b7468d853a99eb332f152e66eccda90bb829f8f685217f09a30daea331f824c88a783ad57bd152a1a78bb63fc4bf305a0577a2bb5421a8c7eb0a36f04b95f547d264f0f29f6037c26b557c172690a184138bade4f74eef5a8144bc050c0489b81a9af28c9220a9ab945c18e6e724edbe8614c6dcc62b4eb94cea4826977c5116381dad4b3a0dffdbbf2c3b73245d6b4b5d48d9c5a5d795845c2b37d4ff5d90b543df517a5ef67f59e564afce757a1a17637953f2259679514145867fc85704f4452347bf5de8d67f44fc3af3183c250bcc3953a8b5f4403a725e81f34e20f5d7407bc78d4dc229db5545a94dd14b29f23a81b1eded918952c50f7ed7217b67bfd446c0da33bf7733f5547c747d96fdb3d2b404ecfb77e90a34b9bf8246f911f7d47e962283971a37130e99b625158b86483abb671585f16a17648e1e9238dd61cce9052dbb58b11260a68737afe94e1e9dc67c3387688ff9f842b50e19afbe9b5aa57bfe5d1723d76d0bc521d9288fb722196d9b7460971b92f4f8ad490dcf2486e773564085cc372c0109cb68cf5ac73e7173de42d7588b130fdb809efe2a8bc5f6b44dbf64489e17e728cc2e9498574df18c4bd7223e333af3e8ab7c4281a22686dd8e34eec687d471bdcca5963a64328529b3f5c6fe2b654f69ce923bcf2918f1be810477c3ed82df26607c34a40e9d6c52a66cc27428b1bd9eb0065c58ba271ce8ec76a3d577d15677839f53b618b8480383aa54c25d8def8ee1d1baa742e3085eb7932c806b120a2242dc453f59b429d6dfcdd643bfa5caf63c327b972062f554b4aaec5d2179e52309d8dbdafb8205ffefce2c3ad6729beeb445512127de3174ab7c80522cdfb1359c97432ce2e37fdf07118280810820e68e2a36d2d0202d0d5c117a2afbd4f8b0bd7c1cc047d716e4a01476ac2ef4d3b122b067762bfe232a0dbfe99292413f5d0f466f65a995bd036961a3a3710d7a732fff00cd4ad0df6c0a7537264d5fcde825aa6663e7a38b3030ff339d5efb967222ebe45077c898942cf13c8aed081989e206a632a296177f4e3b5e789dcff7f8f26dc1da206977346b4245472ae7b19157c5579b4e694f07c9956324c3e3a0ca4cbd17eb076428dd16c3c01eb1294ac73bf89df2811e8757e26145230b63e9a0426bf58eed9a6deca8b301286670802d223eff8978a207983da6e6efa337403e07abe1d197fa9ee26271ef791cf97374b7e92666d6f3a6f1e9ae4a4952ccf270e09d27bcc2c30c08ef5d478fdfd219", "6053aa5552ab190b35be32c486c54221fd464370da27d43a65c2ff900d89a8b68aa6e6b505b12167b0d5be673817c690ac0ca50cb5d327a90a9499c66844f390e243ed4dccd9678fb5a4633a7152ff07d1705975eacb93f236a1bd4551da5d76dbde83ca4004e2deac8ef8495e9bc64c24893d8b477943b2378fb079ef409a50d596eea40adbb82ce1c379ec49e5d71466dba067ddc529093e1715e11b5bcacf13f37f8fc60ce2905780269bd925f5ba6102b6509668181e047f40deed36da128b3c7d8cd142eba8d1d774a86451353f12e84ee145f0b7c2f5aa670ba9ac3f23408a186e535c4c04f2bf9ad515dd425c02d681e3b98967c4af6768e9bc3f76d9f95269711e28952744a28dabdbf4926f92d45b3d0bd5c2ec0431631c7c2cf258ad6f67128d31166c12c58c606d057e208f1c1152f54b8061b1d0864c716d37cac1ea947e264abbbcb995e6b5cd03259bee617ecf96ae7c911539af56670910ac8f17ac44daf3ffcdb221bab5f0a953b704ae788ea9513c7495278657a4a70edb0f81cbf8dcdbe2083875906a528c45bbebc3eca7c345709314a46be4e6586872d3ddb6e40cc288224e753d68ba508a5de17ed5ca2fd33ee363752460bca0139bb9d06d3401528fc9a0fa9e4d8cd7210719b89ece1feea1ec3f307cd66a97db2ee80a4ed36abd3ccb8b4f1ae1fa4f847e4f76931d11f79efebe9990fa987f7371ed69e4591f875f7591b009f9d5d21ce3adc84a7dd1f6c367d27af14190e1162af33a2ccf8dbc541c931f2bf8014a766781f94edd1b11960f9a056c66ad29e8dff6be1db2a63063f5ff51781c8eb682832f1693c47466ef666c4af7c731d1dc10d38c247110ea5551477a39d16d7ee7f5d01dbe849f1382c019e17573f6549348f14db7fedd6b91f86fd614a0da2c04b7264bb98221c2f37a5f157e3a4fa01faeede093f4a088c8d2e13e3627653732222aad8473d1201c48a19b75129eee323bf231ea1b043a36679a4aaf64e2ab801a64902504f328cb39208c19be129cf1e46fbbcc347fb050bae3b041d0138d1014326ab99e3ca0aa33fba643a722884b390e024fbe0127a4050dcdd17acb84f6c3540ec127d3976fb8793dd416c62b0ca60cf3308f97f7cec8345a749bfb95c8e18d57c00cd115e75f9207378de8a9cadc29f71ec1f173af0c5934399b092a028d986ec44264702583c27c699a665f378b83fdf081c581bbb0e82809d86615d34f35506c4ae7015a5debb9f9abaf4984db32736fcbb15c61c684f15195da1da9a21dcf4ae847c6869a7dbcb5ea9232b847248df676d789b33c11ec09ae585731d8c9c0b6a9dd64ecddc809b49f530bee7fa54f560a4ae0463f6c3abc7660a8f13bfddd0fe6ba691b0c590d8e738dc811680ea5cdd9b181be1ab015bc80e6873af97c977f54537a12587b62d5cb246592" }
	};

	private static void TestInternal(IBlockModeOneShot crypto, ReadOnlySpan<byte> iv, ReadOnlySpan<byte> plain, ReadOnlySpan<byte> cipher)
	{
		Assert.Equal(cipher.Length, crypto.GetMaxByteCount(plain.Length));
		Assert.Equal(16, crypto.BlockSize);
		Assert.Equal("AES-XTS", crypto.Name);

		Span<byte> buffer = stackalloc byte[plain.Length + 1];
		RandomNumberGenerator.Fill(buffer);

		crypto.Encrypt(iv, plain, buffer);
		Assert.True(buffer.Slice(0, plain.Length).SequenceEqual(cipher));

		crypto.Decrypt(iv, cipher, buffer);
		Assert.True(buffer.Slice(0, cipher.Length).SequenceEqual(plain));

		crypto.Dispose();
	}

	[Theory]
	[MemberData(nameof(Data))]
	public void TestDataUnitSeqNumber(string keyHex, UInt128 dataUnitSeqNumber, string plainHex, string cipherHex)
	{
		ReadOnlySpan<byte> key = keyHex.FromHex();
		Span<byte> iv = stackalloc byte[16];
		XtsMode.GetIv(iv, dataUnitSeqNumber);
		ReadOnlySpan<byte> plain = plainHex.FromHex();
		ReadOnlySpan<byte> cipher = cipherHex.FromHex();

		ReadOnlySpan<byte> key1 = key.Slice(0, key.Length >> 1);
		ReadOnlySpan<byte> key2 = key.Slice(key.Length >> 1);

		TestInternal(new XtsMode(AesCrypto.CreateCore(key1), AesCrypto.CreateCore(key2)), iv, plain, cipher);
	}

	[Theory]
	[MemberData(nameof(Data2))]
	[MemberData(nameof(Data3))]
	public void Test(string keyHex, string ivHex, string plainHex, string cipherHex)
	{
		ReadOnlySpan<byte> key = keyHex.FromHex();
		ReadOnlySpan<byte> iv = ivHex.FromHex();
		ReadOnlySpan<byte> plain = plainHex.FromHex();
		ReadOnlySpan<byte> cipher = cipherHex.FromHex();

		ReadOnlySpan<byte> key1 = key.Slice(0, key.Length >> 1);
		ReadOnlySpan<byte> key2 = key.Slice(key.Length >> 1);

		TestInternal(new XtsMode(AesCrypto.CreateCore(key1), AesCrypto.CreateCore(key2)), iv, plain, cipher);
	}
}
