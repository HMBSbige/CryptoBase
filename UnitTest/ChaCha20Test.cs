using CryptoBase;
using CryptoBase.Abstractions.SymmetricCryptos;
using CryptoBase.BouncyCastle.SymmetricCryptos.StreamCryptos;
using CryptoBase.SymmetricCryptos.StreamCryptos.ChaCha20;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using System;

namespace UnitTest
{
	[TestClass]
	public class ChaCha20Test
	{
		private static void TestCounter1(SnuffleCryptoBase crypto, string hex, string hex2)
		{
			Assert.AreEqual(@"ChaCha20", crypto.Name);
			Assert.AreEqual(12, crypto.IvSize);

			Span<byte> h1 = hex.FromHex();
			Span<byte> h2 = hex2.FromHex();
			Span<byte> i1 = stackalloc byte[255];
			Span<byte> o1 = stackalloc byte[i1.Length];

			h1.CopyTo(i1.Slice(64));

			crypto.Update(i1, o1);
			Assert.IsTrue(o1.Slice(64, 114).SequenceEqual(h2));

			crypto.Reset();

			h1.CopyTo(i1.Slice(64));

			crypto.Update(i1, o1);
			Assert.IsTrue(o1.Slice(64, 114).SequenceEqual(h2));

			crypto.Dispose();
		}

		private static void Test(SnuffleCryptoBase crypto, string inputHex, string outputHex)
		{
			Assert.AreEqual(@"ChaCha20", crypto.Name);
			Assert.AreEqual(12, crypto.IvSize);

			Span<byte> i = inputHex.FromHex();
			Span<byte> o = outputHex.FromHex();
			Span<byte> o1 = stackalloc byte[i.Length];

			crypto.Update(i, o1);
			Assert.IsTrue(o1.SequenceEqual(o));

			crypto.Reset();

			crypto.Update(i, o1);
			Assert.IsTrue(o1.SequenceEqual(o));

			crypto.Dispose();
		}

		/// <summary>
		/// https://tools.ietf.org/html/rfc8439#section-2.4.2
		/// </summary>
		[TestMethod]
		[DataRow(@"000102030405060708090A0B0C0D0E0F101112131415161718191A1B1C1D1E1F",
			@"000000000000004A00000000",
			@"6E2E359A2568F98041BA0728DD0D6981E97E7AEC1D4360C20A27AFCCFD9FAE0BF91B65C5524733AB8F593DABCD62B3571639D624E65152AB8F530C359F0861D807CA0DBF500D6A6156A38E088A22B65E52BC514D16CCF806818CE91AB77937365AF90BBF74A35BE6B40B8EEDF2785E42874D",
			@"4C616469657320616E642047656E746C656D656E206F662074686520636C617373206F66202739393A204966204920636F756C64206F6666657220796F75206F6E6C79206F6E652074697020666F7220746865206675747572652C2073756E73637265656E20776F756C642062652069742E")]
		public void TestCounter1(string keyHex, string ivHex, string hex, string hex2)
		{
			var key = keyHex.FromHex();
			var iv = ivHex.FromHex();
			TestCounter1(new BcChaCha20Crypto(key, iv), hex, hex2);
			TestCounter1(new ChaCha20CryptoSF(key, iv), hex, hex2);
			TestCounter1(new ChaCha20CryptoX86(key, iv), hex, hex2);
			TestCounter1(StreamCryptoCreate.ChaCha20(key, iv), hex, hex2);
		}

		[TestMethod]
		[DataRow(@"1C9240A5EB55D38AF333888604F6B5F0473917C1402B80099DCA5CBC207075C0",
			@"1C000000000000004A000000",
			@"49EEE0DC249040CDC5408F4705BCDD8147C68DE6B18FD7CB090E6E22481FBFB85CF71E8AC123F2D4194B010F4EA443CE01C667DA03911890A5A48E4503B32DAC7492D35347C8DD25536C0203870D110C58E31218FD2A5B400C30F0B83F43CEAE653A7D7CF454AACC3397C377BAC570DED7D513A565C45F0F461A0D97B5F3BB3C840F2BC5AAEAF26CC9B50CEE15F37DBE9F7B5AA6AE4F83B6794941F45818CB867F300EF87D4436EA75EB8884403CAD4F6F316BAA5DE5A5C52166E9A7E3B2158878F679A15947124E9F9F641AA0225B08BE7C36C22B66331BDD6071F7478C61C3DA8A781E16FA1E8681A6172AA7B5C2E7A4C742F1CF6ACAB445CFF393F0E7EAF6F4E633438493A5679B165858800F2B5C2474757F9581B7307A33A7F794873227105D144C4329DD26BD3E3C0EFE0EA510EA6B64FD73C6EDECA8C9BFB3BA0B4D0770FC16FD791ED7C5494E1C8B8D791BB1ECCA60094C6AD50949460088228DCEEAB11711DE42D223C17211F55073044047F95DE7A726B17EB03F58C152AB12679D3F434B68D49C6838078A2D3EF3AF6A4BF9E5316922F9A669C69C969A1235951D95D5DDBEBF935324FDEBC20A64B077006F88C43718697CD74192554C03A19A4B15E5DF7F373372C18B1067A3015794257B38717EDD1ECC7355D28EEB07DDF1DA58B14790FE422172A3547AA040EC9FDDC6846ECAAEE368B49DE478FF57F2F81B03A131D9DE8DF5229CDD20A41E27B1764F4455E29BA19CFE54F7271BF4DE02F51B55485CDC214B9E4B6EED4623DC65B2CF795F28E09E8BE74C9D8AFFC1A628B865698A4529EF7485DE79C708AE30B0F4A31D5141ABCECBF6B5D86DE085E198B343BB86830AA0F5B7040BFA711FB0F6D9130015F0C7EB0D5A9FD7B96C651422456E45323E7E601A12978214FBAA0422FAA0E57E8C7802485D78335A7CADDB29CEBB8B61A4B742E2AC8B1AD92F0B8B622183357EAD73C2B56C10263807E5C73680E2231261F5484B2BC5DF15D98701AAAC1E7CAD73781863E08B9F81D8126A2810BE04688A097C1B1C8366804780E8FD351C976FAE491066CCC6D8CC3A8491207772E424D2379FC5C92594105F40006499DCAED72109785015AC5FC62CA20BA939876E6DABDE085116C713E9EAED068E2CF8378CF0A6968D43B69837B243EDDEDF891AE7EB9DA17B0B77B0E275C0F198D98055C93491D159E84B0FC1A94B7A840620A85DFAD1DE70562F9E919C20B324D8843DE18C7E6252E5444B9FC29303EA2B59C5FA3F912BBB23F5B27BF538AFB3EE63DC7BD1FFAA8BAB826B3704EB74BE79B98390EF205946FFE9973E2FEEB66418384C7A4AF961E89AA1B501A647D311D4CED3914988C7B84DB1B9076D1672AE465E03A14BB60230A83DA9072A7C19E76287E3822F6FE109D99497EADD589EAE767E35E5B4DA7EF4DEF73287CD93BF11",
			@"E7D482CB5762AD23FB5F3205B90958E2C7AC5A5A522969A755D2DE9FBF7F2A788955E6D37AA1060D7F2B1CC4458A71059711AD065349DE58FBFBAA6A513AB947F58E3CA08DF4D3D7B00DD0BDAE8908B97CC30A583DDD78F756231E26A333D362E508E9A063F03BA5F9DD5104C2EFD710FD3CF9092140069D69C0582DEDB4A5BD670CBEF92384144778FFA147997ACCBD3A4B3F6F446B279BE3242ABCE38F947A7BB58A9D3A3C87C3AA70FB7F307D8793EF38DF6DA164E6C1061842784E7AF22C41462C8A5ECB94A0F1ED6F93637E2CD2C48F537F44D9A0562AD8E9559539148655DA936319E9D64B2CE5F42E5DDA02D3C0C729039AB4AE645EE9468084E2B5308E3DB906C047C42438E42F1FF8C496BC8E3A9D3D1E1C5BA28CD112E2A7C81083ECBCC606137AD9B92E218FC710636028D25E9624D742A5F5513DA8BD03362AFDFC882B0E49CD1E8834334381A93A9C4057702D6D9661B1F9CE2B723DB5FE3E33BF32C0F01459B41926DD83626AB300CCAB9455E37CCFEA42C98CCFC1D62A9F9A16742B4651544DB11D5E4FD7EB52CB1301FC3038ED9C7A67863481FEE0EFEC2DFA81FDB87F51215CF5C6917EE8077687E9DF289AB877254B1591D242C868DF5C8BC1C71BE78FA2A2CF641026C65846E7F12FE1FD2E5336354312D8C256674A7BF4A976485ED01D352804A0FAB7917F03C1CCA3784EA06BDB3303131DC45CFEAB5C97A0E8713D5EDAAED93212978432618801961B7D1407F233F6133DC48EAA54D4A6DF6E71B08A95969F677AA06014885447727A4BE7B7F2B669285D6033AFC5A1DDF6E39A662F332B6FF15F2CF297E99C0C037A5B5364DED6BF43BC857DD3D5348D85D34C2C30D3842DE47A90FADF878F3A20729EF96BDE5957D9B1DD52FB76F35FA3A7422F38B1FBF8600915CEBB2162F1BE093345E05164177639C5BBB3A77C027D5D90207FC15BA1DADEF1173406D87CEA300B8FB6468EC30ACDBE32921996C53E4E4AE3D639B41355CC026D05F700F5480131175B5AE06438C288B105B900C1A681726AB54477EB67AFFFFEC5C39288B982FD9E43F0870716D1EAD3731F3B0F70002E088464396251042E935DA9180CA2FAA7DE4E9AA261A7CCED191FE1CA294A2D7C7680164E1BBC82F1F7BD1EA99CE57166216C2985126889BFD476A7D24D1969764B446BF25A4DC1790ABE9F51E5DEAEAFAFC9EA6224A197421859FEE094348843E8A562BC89FB89C4B855CE4375C6809C6EA30A6D628A53D495721E49576D22E02AD5F3520894390810C23A2C004D94DCC08C4B3CD78FD5731DEC5CB93227F6EA92F35B363039CBCCEFB53746C198FF841BF014E4C4303B5C958AC6817702A41A6E8B1A225D27116A384E8C947769B385F4A76B0EFE505AE5A2A1FCE5D78E9455D430B243C43D6B63AABE9ED870E565CD530FB39A5713E0A64337")]
		public void Test(string keyHex, string ivHex, string hex, string hex2)
		{
			var key = keyHex.FromHex();
			var iv = ivHex.FromHex();
			Test(new BcChaCha20Crypto(key, iv), hex, hex2);
			Test(new ChaCha20CryptoSF(key, iv), hex, hex2);
			Test(new ChaCha20CryptoX86(key, iv), hex, hex2);
			Test(StreamCryptoCreate.ChaCha20(key, iv), hex, hex2);
		}
	}
}
